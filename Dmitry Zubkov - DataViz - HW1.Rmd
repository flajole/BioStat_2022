---
title: "Визуализация данных. HW1"
author: "Дмитрий Зубков"
date: "October 17, 2022"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(skimr)
library(ggpubr)
Sys.setlocale("LC_CTYPE", "russian")
knitr::opts_chunk$set(echo = TRUE)
```

## Задание 1-2

```{r download}
df <-  read_csv("insurance_cost.csv")
skim(df)
```

## Задание 3-6
```{r charges_density}
charges_mean <- round(mean(df$charges))
charges_median <- round(median(df$charges))


charges_density <-
  ggplot(df, aes(x = charges)) +
  geom_density() +
  geom_vline(xintercept = charges_mean, color = "red") +
  geom_vline(xintercept = charges_median, color = "blue") +
  annotate("text", color = "red",
           x = charges_mean+6000, 
           y = 6e-05, 
           label = paste0("Mean = ", charges_mean)) + 
  annotate("text", color = "blue",
           x = charges_median-6000, 
           y = 7e-05, 
           label = paste0("Median = ", charges_median)) + 
  xlab("Траты в год") +
  ylab("Плотность") +
  theme_minimal()

charges_density

```


```{r charges_factor}
charges_sex <- 
  ggplot(df, aes(x = charges, y = sex)) +
  geom_boxplot() +
  xlab("Траты в год") +
  ylab("Пол") +
  theme_minimal()
charges_smoker <- 
  ggplot(df, aes(x = charges, y = smoker)) +
  geom_boxplot() +
  xlab("Траты в год") +
  ylab("Курение") +
  theme_minimal()
charges_region <-
  ggplot(df, aes(x = charges, y = region)) +
  geom_boxplot() +
  xlab("Траты в год") +
  ylab("Регион") +
  theme_minimal()

combine_plot <- ggarrange(charges_sex, charges_smoker, charges_region,
                          ncol = 3, nrow = 1)

combine_plot
```


```{r charges_combine}
combine_plot <- 
  ggarrange(charges_density, combine_plot, nrow= 2, ncol = 1) %>% 
  annotate_figure(top = "Распределение трат в год в зависимости от факторов")

combine_plot
```

```{r charges_region}
df.sum <- 
  df %>%
  group_by(region) %>%
  summarize(mean = round(mean(charges)), 
            median = round(median(charges)))

ggplot(df, aes(x = charges)) +
  facet_wrap(~region) +
  geom_density() +
  geom_vline(data = df.sum,
             aes(xintercept = mean), color = "red") +
  geom_vline(data = df.sum,
             aes(xintercept = median), color = "blue") +
  geom_text(data = df.sum, 
            aes(x = mean + 12000, label = paste0("Mean = ", mean)),
            color = "red",
            y = 6e-05) +
  geom_text(data = df.sum, 
            aes(x = median + 12000, label = paste0("Median = ", median)),
            color = "blue",
            y = 7e-05) +
  xlab("Траты в год") +
  ylab("Плотность") +
  ylim(c(0, 7e-05)) +
  theme_minimal()
```

## Задание 7-10
```{r charges_age}
ggplot(df, aes(x = age, y = charges)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```
```{r charges_age_smokers}
ggplot(df, aes(x = age, y = charges, color = smoker)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```

```{r charges_bmi_smokers}
ggplot(df, aes(x = bmi, y = charges, color = smoker)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  xlab("Индекс массы тела") +
  ylab("Траты в год") +
  theme_minimal()
```

## Задание 11-13
### Форма распределения страховых застрат

Посмотрим еще раз на распределение страховых затрат.

```{r charges_density1, echo = F}
ggplot(df, aes(x = charges)) +
  geom_density() +
  ggtitle("Распределение трат в год") +
  xlab("Траты в год") +
  ylab("Плотность") +
  theme_minimal()
```

Видно, что распределение сильно смещено влево. Попробуем логарифмическую шкалу, может быть это выровняет распределение.

```{r charges_density2, echo = F}
ggplot(df, aes(x = charges)) +
  geom_density() +
  scale_x_log10() + 
  ggtitle("Распределение трат в год (логарифмическая шкала)") +
  xlab("Траты в год") +
  ylab("Плотность") +
  theme_minimal()
```

Видно, что распределение стало симметричнее и приблизилось к нормальному. Поэтому далее будем пользоваться логарифмической шкалой для страховых затрат.

### Влияние BMI и курения на страховые затраты

Взглянем еще раз на график зависимости трат от BMI в группах курящих и некурящих.

```{r charges_bmi_smokers1, echo = F}
ggplot(df, aes(x = bmi, y = charges, color = smoker)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  xlab("Индекс массы тела") +
  ylab("Траты в год") +
  theme_minimal()
```

Видно, что выборка сильно разделяется по фактору курения и по BMI, причем значение **BMI = 30** служит своего рода водоразделом. Это же значение BMI - пограниченое для ожирения. Создадим новую факторную переменную obesity и посмотрим на распределение и боксплоты.

```{r charges_obesity_smokers1, echo = F}
df <- mutate(df, obesity = case_when(bmi < 30 ~ "BMI < 30",
                                     bmi >= 30 ~ "BMI >= 30"))

ggplot(df, aes(x = charges, color = smoker, linetype = obesity)) +
  #facet_wrap(~obesity*smoker) +
  geom_density() +
  scale_x_log10() + 
  ggtitle("Распределение страховых затрат в разных подгруппах") +
  xlab("Траты в год") +
  ylab("Плотность") +
  theme_minimal()

df %>%
  ggplot(aes(x = obesity, y = charges, fill = smoker)) +
  facet_wrap(~smoker) +
  geom_boxplot() +
  scale_y_log10() + 
  ggtitle("Влияние ожирения на траты в год в подгруппах курящих и некурящих") +
  xlab("Ожирение") +
  ylab("Траты в год") +
  theme_minimal()
```

Проверим также линии тренда для зависимости страховых затрат от возраста в подгруппах курящих/некурящих и клиентов с ожирением/без ожирения. Два синонимичных графика:

``` {r charges_obesity_smokers2, echo = F}
ggplot(df, aes(x = age, y = charges, color = smoker)) +
  facet_wrap(~obesity) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  scale_y_log10() + 
  ggtitle("Зависимость страховых затрат от возраста в подгруппах с ожирением и без") +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()

ggplot(df, aes(x = age, y = charges, color = obesity)) +
  facet_wrap(~smoker) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = lm) +
  scale_y_log10() + 
  ggtitle("Зависимость страховых затрат от возраста в подгруппах курящих и некурящих") +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```

Выводы:

* Курение повышает страховые затраты.
* Ожирение не влияет на страховые затраты в подгруппе некурящих и ассоциировано с их повышением в группе курящих.
* Судя по предыдущему графику, на котором выборка некурящих "расщеплена" вне зависимости от степени ожирения, возможно, есть еще какой-то фактор, который влияет на страховые затраты.

### Влияние числа детей на страховые затраты

Во всем предыдущем анализе мы не анализировали еще два фактора, которые есть в исходных данных -- число детей в семье.

Построим же боксплоты величины затрат для разного числа детей в подгруппе некурящих, чтобы исключить влияние фактора курения.

```{r charges_children1, echo = F}
df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = factor(children), y = charges)) +
  geom_boxplot() +
  ggtitle("Влияние количества детей в семье на страховые затраты в подгруппе некурящих") +
  xlab("Число детей") +
  ylab("Траты в год") +
  theme_minimal()
```

Есть тенденция к росту затрат при росте числа детей. Изучим зависимость трат от возраста и числа детей.

```{r charges_children2, echo = F}
df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = age, y = charges, color = factor(children))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = lm) +
  scale_y_log10() + 
  ggtitle("Зависимость страховых затрат от возраста и числа детей в подгруппе некурящих") +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```

Выводы:

* Есть тенденция к более высоким затратам при росте числа детей в семье от 0 до 4. 
* Эта разница более выражена в раннем возрасте. 
* Точнее сказать сложно, поскольку число клиентов с большим числом детей невелико.
* Число детей в семье клиента не объясняет ранее обнаруженное "расщепление" выборки.

### Влияние пола на страховые затраты

Проведем те же манипуляции для изучения влияния пола в подгруппе некурящих.

```{r charges_sex, echo = F}

df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = sex, y = charges)) +
  geom_boxplot() +
  ggtitle("Влияние пола на страховые затраты в подгруппе некурящих") +
  xlab("Число детей") +
  ylab("Траты в год") +
  theme_minimal()

df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = age, y = charges, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = lm) +
  scale_y_log10() + 
  ggtitle("Зависимость страховых затрат от возраста и пола в подгруппе некурящих") +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```

Выводы:

* Есть тенденция к более высоким затратам на женщин, нежели на мужчин.
* Эта разница более выражена в раннем возрасте. 
* Пол не объясняет ранее обнаруженное "расщепление" выборки.

### Влияние региона на страховые затраты

Проведем те же манипуляции для изучения влияния региона в подгруппе некурящих.

```{r charges_region1, echo = F}
df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = region, y = charges)) +
  geom_boxplot() +
  ggtitle("Влияние региона на страховые затраты в подгруппе некурящих") +
  xlab("Число детей") +
  ylab("Траты в год") +
  theme_minimal()


df %>%
  filter(smoker == "no") %>%
  ggplot(aes(x = age, y = charges, color = region)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = lm) +
  scale_y_log10() + 
  ggtitle("Зависимость страховых затрат от возраста и региона в подгруппе некурящих") +
  xlab("Возраст, лет") +
  ylab("Траты в год") +
  theme_minimal()
```

Выводы:

* Есть тенденция к более высоким затратам в регионах northeast и northwest.
* Эта разница более выражена в раннем возрасте. 
* Регион не объясняет ранее обнаруженное "расщепление" выборки.

## Задание 14

```{r logcharges_age_bmi}
df <- mutate(df, age_group = case_when(age < 35 ~ "age: 18-34",
                                       age >= 35 & age < 50 ~ "age: 35-49",
                                       age >= 50 ~ "age: 50+"))

ggplot(df, aes(x = bmi, y = log(charges), color = age_group)) +
  facet_wrap(~age_group) +
  geom_point(fill = "#451874", color = "#451874", 
             shape = 21, alpha = 0.5) +
  geom_smooth(method = lm, formula = y ~ x) +
  ggtitle("Отношение индекса массы тела к логарифму трат по возрастным группам") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5))
```